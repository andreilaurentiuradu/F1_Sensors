#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "structs.h"

typedef void (*function_ptr)(void *);
void get_operations(void **operations);

void read_tire_sensor(tire_sensor *s, FILE *in) {
    fread(&s->pressure, sizeof(float), 1, in);
    fread(&s->temperature, sizeof(float), 1, in);
    fread(&s->wear_level, sizeof(int), 1, in);
    fread(&s->performace_score, sizeof(int), 1, in);
}

void print_tire_sensor(tire_sensor *s) {
    printf("Tire Sensor\n");
    printf("Pressure: %.2f\n", s->pressure);
    printf("Temperature: %.2f\n", s->temperature);
    printf("Wear Level: %d%%\n", s->wear_level);
    if(s->performace_score != 0)
        printf("Performance Score: %d\n", s->performace_score);
    else
        printf("Performance Score: Not Calculated\n");
}

void read_PMU(power_management_unit *s, FILE *in) {
    fread(&s->voltage, sizeof(float), 1, in);
    fread(&s->current, sizeof(float), 1, in);
    fread(&s->power_consumption, sizeof(float), 1, in);
    fread(&s->energy_regen, sizeof(int), 1, in);
    fread(&s->energy_storage, sizeof(int), 1, in);
}

void print_PMU(power_management_unit *s) {
    printf("Power Management Unit\n");
    printf("Voltage: %.2f\n", s->voltage);
    printf("Current: %.2f\n", s->current);
    printf("Power Consumption: %.2f\n", s->power_consumption);
    printf("Energy Regen: %d%%\n", s->energy_regen);
    printf("Energy Storage: %d%%\n", s->energy_storage);
}

int cmpfunc(const void *a, const void *b) {
    int x, y;
    if ((((sensor *)a)->sensor_type) == TIRE)
        x = 1;
    else
        x = 0;

    if ((((sensor *)b)->sensor_type) == TIRE)
        y = 1;
    else
        y = 0;

    return x - y;  //  daca e pozitiv se face interschimbarea
}

void swap_sensors(sensor *a, sensor *b) {
    sensor aux = *a;
    *a = *b;
    *b = aux;
}

void analyze(sensor *s, function_ptr *op) {
    for(int i = 0; i < s->nr_operations; ++i) {
        op[s->operations_idxs[i]](s->sensor_data);
    }
}

int main(int argc, char const *argv[]) {
    // DECLARARI SI ALOCARI DE MEMORIE
    int nr_senzori, tip_senzor;
    //FILE *out = fopen("output_ana", "w");
    FILE *in = fopen(argv[1], "rb");
    //FILE *temporar = fopen("input_ana", "r");
    function_ptr *op = (function_ptr *)malloc(8 * sizeof(function_ptr));

    // //OPERATII EFECTIVE
    get_operations((void **)(op));
    fread(&nr_senzori, sizeof(nr_senzori), 1, in);
    // printf("nr_senzori: %d\n", nr_senzori);
    //   alocam memorie pentru vectorul de senzori
    sensor *sen = (sensor *)malloc(nr_senzori * sizeof(sensor));
    for (int i = 0; i < nr_senzori; ++i) {
        fread(&tip_senzor, sizeof(tip_senzor), 1, in);

        if (tip_senzor == 1) {         // senzor de tip PMU
            sen[i].sensor_type = PMU;  // punem campul pe PMU
            sen[i].sensor_data =
                (power_management_unit *)malloc(sizeof(power_management_unit));
            read_PMU((power_management_unit *)(sen[i].sensor_data), in);
            // print_PMU((power_management_unit *)(sen[i].sensor_data));
        } else {
            sen[i].sensor_type = TIRE;  // punem campul pe PMU
            sen[i].sensor_data = (tire_sensor *)malloc(sizeof(tire_sensor));
            read_tire_sensor((tire_sensor *)(sen[i].sensor_data), in);
            // print_tire_sensor((tire_sensor *)(sen[i].sensor_data));
        }
        fread(&sen[i].nr_operations, sizeof(int), 1, in);
        sen[i].operations_idxs =
            (int *)malloc(sen[i].nr_operations * sizeof(int));

        for (int j = 0; j < sen[i].nr_operations; ++j) {
            fread(&sen[i].operations_idxs[j], sizeof(int), 1, in);
        }
        // printf("\n\n");
    }
    // printf("ACUM SORTAM VECTORUL\n");

    // bubble sort
    int not_sorted = 1;
    while (not_sorted) {
        not_sorted = 0;
        for (int i = 0; i < nr_senzori - 1; ++i) {
            if (cmpfunc(&sen[i], &sen[i + 1]) > 0) {
                swap_sensors(&sen[i], &sen[i + 1]);
                not_sorted = 1;
            }
        }
    }


    char *operation = (char *)malloc(100 * sizeof(char));
    int index;
    do {
        scanf("%s", operation);
        // printf("operatia este %s\n", operation);
        if (strcmp(operation, "print") == 0) {
            scanf("%d", &index);

            // printf("indexul este %d\n", index);

            if (index < 0 || index >= nr_senzori)
                printf("Index not in range!\n");
            else {
                if (sen[index].sensor_type == PMU)
                    print_PMU(
                        (power_management_unit *)(sen[index].sensor_data));
                if (sen[index].sensor_type == TIRE)
                    print_tire_sensor((tire_sensor *)(sen[index].sensor_data));
            }
        }

        if (strcmp(operation, "analyze") == 0) {
            scanf("%d", &index);

            // printf("indexul este %d\n", index);

            if (index < 0 || index >= nr_senzori)
                printf("Index not in range!\n");
            else {
                analyze(&sen[index], op);
            }
        }
        if (strcmp(operation, "exit") == 0) {
            break;
        }
    } while (1);

    // ELIBERARI DE MEMORIE
    for (int i = 0; i < nr_senzori; ++i) {
        free(sen[i].sensor_data);  // eliberam memoria pentru
        // sen[i].sensor_data(campul care retine practic senzorul)
        free(sen[i].operations_idxs);
    }
    free(operation);
    free(op);    // vect de operatii
    free(sen);   // eliberez memoria ocupata de vectorul de senzori
    fclose(in);  // inchidem fisierul binar din care am citit
    return 0;
}

// to do
// 3 faci functia clear care sterge toti senzorii care au valori eronate
// 4 faci functia analyze care aplica funtiile retinute in vectorul de pointeri
// 5 verifici sa nu ai leakuri de memorie
// 6 coding style si readme

// sen->sensor_type = PMU;
// if(sen->sensor_type == PMU)
// {
// 	sen->sensor_data = (tire_sensor *)malloc(sizeof(tire_sensor)); // aloc
// memorie pentru variabile de tip tire_sensor
// 	((tire_sensor *)sen->sensor_data)->temperature = 500; // fac castul la
// tire_sensor pentru a avea acces la campuri

// 	op[sen->operations_idxs[0]](sen->sensor_data);
// }

// // sen->sensor_type->temperature = 50;
// get_operations((void **)sen->operations_idxs);
// sen->operations_idxs[1]((void *) sen);
// sen->operations_idxs[0](NULL);
// int (* anotherFunction)(int, int)
